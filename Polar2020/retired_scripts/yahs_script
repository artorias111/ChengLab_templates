#!/usr/bin/bash

# For Phase genomics 2023 samples
# A Shell script wrapper for Polar2020 to run YaHS, in order to scaffold assemblies generated by Hifiasm using HiC raw reads. 

# prerequisites : 
# 1. activate the conda env for salsa
# conda activate /data2/work/local/miniconda/envs/salsa
# 2. make sure the assembly file is indexed with samtools, and it's in the same directory as the fasta file
#       You can index a fasta file using `samtools faidx genome.fa`

# Please COPY this script in another directory before modifying/running the script

# Required parameters: 
# -g assembly 
# -a read pair 1 
# -b read pair 2 

# PLEASE provide the ABSOLUTE PATH for the files, or make symlinks

# Example run : ./yahs_script -g dele_asm.fa -a dele_R1.fq.gz -b dele_R2.fq.gz


# -----------------------------------------

assembly=""
r1=""
r2=""
bed_file=""

while getopts ":g:a:b:" opt; do
    case $opt in 
        g)
            echo "Assembly file is in $OPTARG" >&2
            assembly=$OPTARG
            ;;
        a)
            r1=$OPTARG
            ;;
        b)
            r2=$OPTARG
            ;;
    esac
done;

# ---------------------------------------------


# part 1 : run bowtie2 on the mate pair reads
BT2_HOME=/data2/work/local/miniconda/envs/salsa/bin
# step 1
$BT2_HOME/bowtie2-build $assembly genome_index -p 120 |& tee bt2_index.tmux.log
# step 2
$BT2_HOME/bowtie2 --local -p 120 -x genome_index -1 $r1 -2 $r2 2>bt2.err.log | samtools sort --threads 120 -o aligned.bam 



# part 2 : run yahs

/data2/work/local/yahs/yahs $assembly aligned.bam -e GATC,CTNAG,TTAA,GANTC |& tee yahs.tmux.log
