#!/usr/bin/bash

# For Phase genomics 2023 samples
# A Shell script wrapper for Polar2020 to run SALSA, in order to scaffold assemblies generated by Hifiasm using HiC raw reads. 
# Read this before running the script

# prerequisites : 
# 1. activate the conda env for salsa
# 2. make sure the assembly file is indexed with samtools, and it's in the same directory as the fasta file
#       You can index a fasta file using `samtools faidx genome.fa`

# Please COPY this script in another directory before modifying/running the script

# Required parameters: 
# -g assembly 
# -a read pair 1 
# -b read pair 2 

# PLEASE provide the ABSOLUTE PATH for the files, or make symlinks

# Example run : ./salsa_script -g dmaw.fasta -a dmaw_R1.fq.gz -b dmaw_R2.fq.gz

# -----------------------------------------

assembly=""
r1=""
r2=""
bed_file=""

while getopts ":g:a:b:" opt; do
    case $opt in 
        g)
            echo "Assembly file is in $OPTARG" >&2
            assembly=$OPTARG
            ;;
        a)
            r1=$OPTARG
            ;;
        b)
            r2=$OPTARG
            ;;
    esac
done;

# ---------------------------------------------


# part 1 : run bowtie2 on the mate pair reads
BT2_HOME=/data2/work/local/miniconda/envs/salsa/bin
# step 1
$BT2_HOME/bowtie2-build $assembly genome_index -p 120 |& tee bt2_index.log
# step 2
$BT2_HOME/bowtie2 --local -p 120 -x genome_index -1 $r1 -2 $r2 2>bt2.err.log | samtools sort --threads 120 -o aligned.bam 
# step 3
bamToBed -i aligned.bam > aligned.bed 
# Sort the bed file according to read name (according to SALSA's requirement)
sort -k 4 aligned.bed > tmp && mv tmp aligned.bed


# part 2 : Run salsa and Juicer
index=${assembly}.fai

/data2/work/local/SALSA/run_pipeline.py -a $assembly -l $index -b aligned.bed -e GATC,CTNAG,TTAA,GANTC -o Salsa_assembly |& tee salsa.log

# Run juicer on SALSA's output assembly
## You can skip this part, since this takes some time. It's needed to visualize the HiC output as a heatmap
/data2/work/local/SALSA/convert.sh Salsa_assembly |& tee juicer.tmux.log
